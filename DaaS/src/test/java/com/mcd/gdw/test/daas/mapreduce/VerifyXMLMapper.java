package com.mcd.gdw.test.daas.mapreduce;

import java.io.IOException;
import java.io.StringReader;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.apache.hadoop.io.LongWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Mapper;
import org.apache.hadoop.mapreduce.lib.input.FileSplit;
import org.w3c.dom.Document;
import org.xml.sax.ErrorHandler;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;

import com.mcd.gdw.daas.DaaSConstants;

public class VerifyXMLMapper extends Mapper<LongWritable, Text, Text, Text> {

	private DocumentBuilderFactory docFactory = null;
	private DocumentBuilder docBuilder = null;
	private InputSource xmlSource = null;
	@SuppressWarnings("unused")
	private Document doc = null;
	private StringReader strReader = null;

	private FileSplit fileSplit = null;
	private String fileName = "";

	private String[] parts = null;
	
	private StringBuffer outKey = new StringBuffer();
	private StringBuffer outValue = new StringBuffer();
	
	private Text mapKey = new Text();
	private Text mapValue = new Text();

	private boolean parseException;
	private String parseMsg;

	private ErrorHandler handler = new ErrorHandler() {
	    public void warning(SAXParseException e) throws SAXException {
	    	parseException = true;
	    	parseMsg = "[warning] "+e.getMessage();
	    }
	    public void error(SAXParseException e) throws SAXException {
	    	parseException = true;
	    	parseMsg = "[error] "+e.getMessage();
	    }
	    public void fatalError(SAXParseException e) throws SAXException {
	    	parseException = true;
	    	parseMsg = "[fatal error] "+e.getMessage();
	    }
	};

	private String fileSubType;
	private String terrCd;
	private String posBusnDt;
	private String lgcyLclRfrDefCd;
	//private String mcdGbalLcatIdNu;
	
	//private static final String LIC_LIST = "@15069@02066@24343@06080@19461@33945@35634@05031@11362@00455@11915@31329@02435@31926@03895@07562@11763@25063@10521@31925@11743@24344@11822@11563@02441@01014@06803@13447@16937@22986@30676@31502@31610@33348@34307@32523@17976@28435@02624@35818@11437@10167@11007@04627@12866@07035@00368@01044@02407@02510@02522@02550@02577@02860@02973@03259@03301@03452@03504@03573@03621@03635@03770@03819@03881@03934@03956@04138@04221@04320@04570@04663@04712@04755@04766@04997@05028@05105@05134@05241@05368@05421@05625@05651@05749@05781@05971@06195@06566@06570@06625@07182@07263@07344@07501@07618@07662@07811@07896@07938@07981@08104@10148@10159@10267@10464@10721@10812@10829@10960@10978@11213@11355@11385@11391@11394@11395@11422@11523@11646@11707@11779@11862@11932@12282@12293@12332@12393@12395@12976@13081@13159@13334@13362@13363@13515@13658@13659@13660@13681@13824@14191@14198@14296@14342@14590@14961@15546@15717@15843@15990@16085@16326@16649@16886@16917@17689@17721@17954@18373@18969@19632@19805@20917@21806@22325@24620@24758@25393@25436@26468@26522@26919@27133@27496@27548@27549@27804@27813@27866@27867@27869@28074@28245@28461@28653@28933@28957@28959@29233@29413@29771@29900@30836@30839@30936@31172@31190@31614@31619@31681@31751@31892@31988@32242@32336@32344@32385@32445@32733@32797@32822@32939@32956@33125@33126@33127@33178@33260@33287@33396@33529@33546@33817@33850@34347@34433@34520@34644@34710@34939@35083@35210@35265@35270@35357@35521@35756@35768@36140@36335@36336@36750@00192@00312@00316@00400@00516@00648@00882@00898@01024@01034@01035@01216@01317@01480@01503@01504@01554@01703@01723@01725@01909@01948@01966@01993@02055@02284@02388@02599@02606@02630@02638@02704@02763@02797@02808@02870@02881@02927@02942@02962@03054@03217@03293@03298@03348@03447@03454@03499@03545@03574@03598@03610@03647@03663@03747@03809@03811@03842@03869@03908@03942@04088@04230@04280@04303@04306@04443@04540@04581@04582@04680@04830@05013@05157@05160@05166@05239@05312@05346@05367@05384@05395@05481@05515@05623@05670@05703@05948@06153@06173@06260@06280@06302@06430@06613@06656@06661@06695@06755@06852@06863@06996@07020@07091@07189@07190@07192@07276@07419@07489@07526@07540@07576@07638@07647@07688@07777@07778@07794@07850@07864@07872@08010@08068@08168@08266@08283@10008@10076@10102@10155@10169@10181@10296@10300@10319@10366@10432@10497@10507@10511@10539@10586@10607@10615@10620@10624@10626@10653@10675@10828@10876@10939@10944@10999@11024@11052@11115@11134@11207@11239@11264@11350@11378@11418@11424@11444@11562@11602@11619@11695@11769@11832@11851@11966@11998@12162@12195@12199@12225@12230@12239@12334@12336@12382@12383@12421@12583@12623@12673@12708@12957@12965@13015@13037@13038@13132@13267@13268@13364@13608@13685@14049@14073@14139@14140@14159@14223@14244@14295@14575@14591@14616@14813@14985@15105@15148@15284@16140@16165@16166@16379@16707@16736@17018@17025@17214@17224@17240@17291@17292@17298@17449@17572@17724@17726@17809@17810@18146@18290@18380@18408@18466@18787@19060@19077@19116@19127@19279@19450@20170@20171@20335@20339@20344@20461@20575@20614@20875@20971@20973@20982@21058@21074@21192@21225@21339@21655@21850@21887@22171@22239@22241@22665@22714@22796@22853@23005@23022@23167@23366@23652@23665@24098@24255@24273@24335@24376@24388@24536@24961@25110@25116@25164@25209@25253@25502@25520@25592@25688@25986@25989@26150@26317@26332@26530@27111@27141@27356@27449@27533@27575@27656@27699@27722@27760@28119@28182@28296@28462@28465@28570@28572@28573@28600@28612@28626@28627@28630@28632@28656@28811@28818@28863@29375@29433@29504@29684@29699@29841@29844@29970@30158@30235@30258@30375@30376@30378@30464@30491@30724@30841@30851@30897@30959@30996@31024@31041@31086@31089@31191@31261@31282@31355@31398@31413@31443@31444@31446@31507@31674@31779@31788@31841@31879@31944@31978@31979@31990@32226@32243@32439@32468@32476@32479@32518@32540@32562@32607@32608@32630@32792@32844@32858@32872@32883@33018@33060@33072@33129@33262@33297@33834@33853@33909@33965@33966@34057@34141@34401@34565@34839@34845@34984@35035@35292@35380@35401@35416@35447@35714@35783@35860@35949@36068@36174@36299@36428@36977@36991@01424@02279@02570@05553@16369@18534@28828@31973@31397@34233@00220@00235@00364@02427@03140@03397@03498@03514@03865@03907@04071@04092@04179@04238@04404@04456@04644@04654@04738@04919@05249@05590@05659@05808@06011@06029@06228@06231@07164@07712@08084@10393@10833@10858@11060@11066@11098@11473@11550@11796@11807@11885@12190@12495@12501@13262@13697@14673@15793@17571@20105@21191@22258@22591@22592@22852@23481@23529@23895@24370@25211@26250@27525@28191@28808@30148@30578@30903@30968@31141@31188@31305@31404@31442@31869@31902@32613@33423@35207@35209@35906@35952@36544@36782@37117@02397@06044@10639@11538@19195@32673@00525@00967@01175@02794@02192@02795@03288@02869@04229@04145@05168@05195@05624@10189@11201@12138@12463@14165@14493@18347@20970@27698@05207@11237@12956@12958@05516@03763@11639@33715@00103@10389@14647@26439@05411@20966@04450@05088@05418@08115@19078@20972@05698@31272@06602@12249@04137@13266@18551@11396@25849@03302@03659@08284@27746@35430@04481@04934@06234@07030@08129@10304@12066@26557@32272@00471@01565@03623@04624@07257@10139@11647@01767@02493@02711@03231@07491@19135@21196@22425@25007@01843@34797@34798@19570@03780@05637@06519@17635@26349@26592@28381@31977@05984@10271@19174@35192@01910@28410@31789@10054@10269@20173@32026@11884@36715@03002";
	private static final String LIC_LIST = "@32344@31190@05028@34233@24370@32939@16917@34710@22325@07501@08084@13334@33850@30903@31751@16085@27866@04138@34939@11796@01424@03397@08104@27867@25436@32445@11473@31681@10833@28074@02522@28828@03819@05249@03907@22258@17689@04238@10159@06231@25211@17571@16649@30578@11646@13515@22591@24620@05590@12282@27549@02860@29900@33127@11779@00235@31973@10812@03770@10978@33396@04919@14590@07182@03865@15793@11355@11807@06625@01044@03956@28191@18534@35210@35207@33817@02407@05553@27496@11391@10721@03498@02570@04221@13362@04071@13681@32797@32336@31172@23481@00364@27813@27525@05105@10267@18373@00368@07938@03881@26522@22852@11394@04997@11550@05134@04179@03259@36335@27804@03140@30148@12501@06011@15546@35768@11422@05368@07263@04570@05241@35521@32385@24758@14191@25393@33126@07164@28957@15990@06566@35270@34644@04644@11523@33178@26919@31442@12976@32733@11885@10464@04092@18969@33125@11213@30836@05749@13824@03514@35265@33546@28933@04456@04755@04663@14198@28808@07344@32242@15717@16886@05651@32822@12393@33529@13262@36140@10829@02550@19632@12332@07618@04766@28245@04712@29233@21191@12190@31902@05808@35209@02973@35357@04320@30968@07662@02279@07896@02510@34520@17954@05625@03573@26468@31614@17721@20917@05659@31188@05781@31619@23529@07811@35083@06228@37117@29771@11395@14673@28959@19805@27548@15843@27869@11066@13081@33287@33423@13659@31892@06570@11707@12495@10960@16369@03621@26250@13697@04404@28653@04738@13660@31397@05971@13159@07981@11862@03635@10858@31141@30839@34347@16326@10148@12395@03452@06029@32956@30936@03504@14296@22592@11060@11932@35756@14961@34433@36336@05421@07712@32613@31305@13658@11385@10393@31404@33260@13363@31869@23895@11098@12293@03301@03934@06195@04654@29413@28461@02577@31988@21806@00220@27133@14342@02427@20105";
	
	@Override
	public void setup(Context context) {
	      
        fileSplit = (FileSplit) context.getInputSplit();
        fileName = fileSplit.getPath().getName();

        /*
        try {
			docFactory = DocumentBuilderFactory.newInstance();
			docBuilder = docFactory.newDocumentBuilder();
			docBuilder.setErrorHandler(handler);

        } catch (Exception ex) {
			System.err.println("Error in initializing VerifyXMLMapper:");
			System.err.println(ex.toString());
			System.exit(8);
		}
		*/
        
	}
	
	@Override
	public void map(LongWritable key, Text value,Context context) throws IOException, InterruptedException {

		try {
			
			parseException = false;
			
			parts = value.toString().split("\t");

			fileSubType = parts[DaaSConstants.XML_REC_FILE_TYPE_POS];
			terrCd = String.format("%03d", Integer.parseInt(parts[DaaSConstants.XML_REC_TERR_CD_POS]));
			lgcyLclRfrDefCd = parts[DaaSConstants.XML_REC_LGCY_LCL_RFR_DEF_CD_POS];
			//mcdGbalLcatIdNu = parts[DaaSConstants.XML_REC_MCD_GBAL_LCAT_ID_NU_POS];
			posBusnDt = parts[DaaSConstants.XML_REC_POS_BUSN_DT_POS].substring(0, 4) + "-" + parts[DaaSConstants.XML_REC_POS_BUSN_DT_POS].substring(4, 6) + "-" + parts[DaaSConstants.XML_REC_POS_BUSN_DT_POS].substring(6, 8);

			//strReader  = new StringReader(parts[DaaSConstants.XML_REC_XML_TEXT_POS]);
			//xmlSource = new InputSource(strReader);
			//doc = docBuilder.parse(xmlSource);
		} catch (Exception ex) { 
			
			if ( !parseException ) {
				System.err.println("Error occured in VerifyXMLMapper.map:");
				ex.printStackTrace(System.err);
				System.exit(8);
			}
		}
		
		if ( LIC_LIST.contains("@"+lgcyLclRfrDefCd)  ) {
			outKey.setLength(0);
			outKey.append(terrCd);
			outKey.append("\t");
			outKey.append(lgcyLclRfrDefCd);
			//outKey.append("\t");
			//outKey.append(mcdGbalLcatIdNu);
			outKey.append("\t");
			outKey.append(posBusnDt);
			outKey.append("\t");
			outKey.append(fileSubType);
			
			mapKey.clear();
			mapKey.set(outKey.toString());

			if ( parseException ) {
				outValue.setLength(0);
				outValue.append("1");
				outValue.append("\t");
				outValue.append(fileName);
				outValue.append("\t");
				outValue.append(parseMsg);
				
				context.getCounter("DaaS","Error-" + fileSubType).increment(1);
				
			} else {
				outValue.setLength(0);
				outValue.append("0");
				outValue.append("\t");
				outValue.append("\t");
				
				context.getCounter("DaaS","OK-" + fileSubType).increment(1);
			}

			mapValue.clear();
			mapValue.set(outValue.toString());

			context.write(mapKey, mapValue);	
		}

	}
}
